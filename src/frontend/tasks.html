<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Listo - Tasks</title>
  <style>
    :root {
      --bg:#0b1020;--panel:#121a32;--muted:#9aa4bf;--text:#e9ecf8;
      --primary:#6ea8fe;--primary-2:#4f86f7;--border:#1f2847;--input:#161e39;
      --danger:#ff5c5c;--danger-2:#e14c4c;
    }
    *{box-sizing:border-box}
    body{font-family:Arial,sans-serif;background:var(--bg);color:var(--text);margin:0}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
    .brand{font-weight:900;font-size:22px}
    .sub{color:var(--muted);font-size:12px;margin-top:2px}
    .h-right{display:flex;gap:10px}
    .btn {
      appearance: none;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, var(--primary), var(--primary-2));
      color: #061024;
      padding: 8px 12px;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      width: 100px;              /* fits cleanly inside the last cell */
      padding: 8px 10px;
      text-align: center;
      display: inline-block;
    }
    .btn.ghost{background:transparent;color:var(--text);width:auto}
    .btn.danger{
      background:linear-gradient(180deg,var(--danger),var(--danger-2));
      color:white;
      border:none;
    }

    .toolbar{display:flex;align-items:center;gap:10px;margin:8px 0 16px}
    .input, select{padding:10px;background:var(--input);border:1px solid var(--border);
      border-radius:10px;color:var(--text)}
    .pill{font-size:12px;color:var(--muted);padding:6px 10px;border:1px solid var(--border);border-radius:999px}

    .table-wrap {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 28px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.3);
    }

    h3 {
      background: #0f1429;
      margin: 0;
      padding: 12px;
      font-size: 16px;
      font-weight: 800;
      border-bottom: 1px solid var(--border);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 900px;
      table-layout: fixed;
    }

    td:last-child, th:last-child {
      width: 130px;
      text-align: right;
      padding-right: 8px;
      overflow: visible;
    }

    thead th {
      text-align: left;
      font-weight: 700;
      padding: 12px;
      border-bottom: 1px solid var(--border);
    }

    tbody td, tfoot td {
      padding: 12px;
      border-bottom: 1px solid var(--border);
      vertical-align: middle;
    }

    td:last-child { text-align: right; padding-right: 16px; }

    tbody tr:hover { background: rgba(255,255,255,.02); }
    tr.completed td { color: var(--muted); text-decoration: line-through; }

    #completed-section .table-wrap { opacity:0.9; background:#101630; }

    input[type="checkbox"] {
      appearance: none;
      width: 18px;
      height: 18px;
      border: 2px solid var(--border);
      border-radius: 6px;
      background: var(--input);
      cursor: pointer;
      position: relative;
      transition: all 0.2s ease;
    }
    input[type="checkbox"]:hover { border-color: var(--primary); box-shadow: 0 0 3px var(--primary); }
    input[type="checkbox"]:checked {
      background: linear-gradient(180deg, var(--primary), var(--primary-2));
      border-color: var(--primary-2);
      box-shadow: 0 0 6px rgba(110, 168, 254, 0.4);
    }
    input[type="checkbox"]:checked::after {
      content: "✓";
      color: #061024;
      font-size: 13px;
      font-weight: bold;
      position: absolute;
      top: 0;
      left: 3px;
    }

    .confirm-popup {
      position: absolute;
      background: #1a213b;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 10px;
      display: flex;
      gap: 6px;
      align-items: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
      z-index: 10;
    }
    .confirm-popup button {
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      border: none;
    }
    .confirm-yes { background: var(--danger); color: white; }
    .confirm-cancel { background: transparent; color: var(--muted); border: 1px solid var(--border); }

    .toast-popup {
      position: absolute;
      background: #1a213b;
      color: var(--danger);
      border: 1px solid var(--danger-2);
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 13px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.45);
      z-index: 15;
      opacity: 0;
      transform: translateY(-4px);
      animation: fadeInOut 2.4s ease forwards;
    }
    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateY(-4px); }
      10%, 85% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(-4px); }
    }

    tfoot input {
      width: 100%;
      padding: 10px;
      background: var(--input);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
    }

    tfoot td {
      background: var(--panel);
      border-top: 1px solid var(--border);
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <div class="brand">Listo</div>
        <div class="sub">Signed in as <span id="whoami">—</span></div>
      </div>
      <div class="h-right">
        <button class="btn ghost" onclick="goToAccount()">Account</button>
        <button class="btn ghost" onclick="logout()">Logout</button>
      </div>
    </header>

    <div class="toolbar">
      <input id="search" class="input" placeholder="Search…" oninput="render()" />
      <select id="sortSelect" onchange="render()">
        <option value="">Sort: None</option>
        <option value="priorityHighLow">Priority: High → Low</option>
        <option value="priorityLowHigh">Priority: Low → High</option>
      </select>
      <span class="pill" id="countBadge">0 tasks</span>
    </div>

    <!-- TO-DO TASKS -->
    <section id="todo-section">
      <div class="table-wrap">
        <h3>To-Do Tasks</h3>
        <table>
          <thead>
            <tr>
              <th style="width:80px"></th>
              <th style="width:260px">Title</th>
              <th>Details</th>
              <th style="width:110px">Priority</th>
              <th style="width:120px;text-align:right;"></th>
            </tr>
          </thead>
          <tbody id="tbody-todo"></tbody>
          <tfoot>
            <tr>
              <td></td>
              <td><input id="newTitle" placeholder="Title (required)" /></td>
              <td><input id="newDetails" placeholder="Details" /></td>
              <td><input id="newPriority" type="number" min="1" max="5" placeholder="Priority" /></td>
              <td><button class="btn" onclick="createTask()">Create Task</button></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </section>

    <!-- COMPLETED TASKS -->
    <section id="completed-section">
      <div class="table-wrap">
        <h3>Completed Tasks</h3>
        <table>
          <thead>
            <tr>
              <th style="width:80px"></th>
              <th style="width:260px">Title</th>
              <th>Details</th>
              <th style="width:110px">Priority</th>
              <th style="width:120px;text-align:right;"></th>
            </tr>
          </thead>
          <tbody id="tbody-completed"></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    const api = (p) => p;
    const $ = (sel) => document.querySelector(sel);
    let TASKS = [];

    async function loadUser() {
      try {
        const res = await fetch(api("/api/users"), { credentials: "include" });
        if (res.status === 401) return window.location.replace("/ui/login");
        const data = await res.json();
        $("#whoami").textContent = data.username || "unknown";
        return true;
      } catch { window.location.replace("/ui/login"); return false; }
    }

    async function syncTasks() {
      try {
        const res = await fetch(api("/api/tasks"), { credentials: "include" });
        if (res.status === 401) return window.location.replace("/ui/login");
        TASKS = await res.json();
        render();
      } catch (e) { console.error("syncTasks", e); }
    }

    async function updateStatus(id, done) {
      try {
        const res = await fetch(api(`/api/tasks/${id}`), {
          method: "PUT",
          credentials: "include",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ is_complete: done }),
        });
        if (res.status === 401) return window.location.replace("/ui/login");
        const i = TASKS.findIndex(t => t.id === id);
        if (i > -1) TASKS[i].is_complete = done;
      } catch (e) { console.error(e); }
    }

    function deleteTask(id, button) {
      document.querySelectorAll(".confirm-popup").forEach(e => e.remove());
      const popup = document.createElement("div");
      popup.className = "confirm-popup";
      popup.innerHTML = `
        <span>Confirm delete?</span>
        <button class="confirm-yes">Yes</button>
        <button class="confirm-cancel">Cancel</button>
      `;
      const rect = button.getBoundingClientRect();
      popup.style.top = `${rect.top + window.scrollY - 4}px`;
      popup.style.left = `${rect.left - 10}px`;
      document.body.appendChild(popup);
      popup.querySelector(".confirm-yes").onclick = async () => {
        popup.remove();
        try {
          const res = await fetch(api(`/api/tasks/${id}`), {
            method: "DELETE",
            credentials: "include",
          });
          if (res.status === 401) return window.location.replace("/ui/login");
          TASKS = TASKS.filter(t => t.id !== id);
          render();
        } catch (e) { console.error(e); }
      };
      popup.querySelector(".confirm-cancel").onclick = () => popup.remove();
    }

    async function createTask() {
      const title = $("#newTitle").value.trim();
      if (!title) {
        const btn = document.querySelector("tfoot button");
        showToast("Title is required", btn);
        return;
      }
      const details = $("#newDetails").value.trim();
      const priority = parseInt($("#newPriority").value) || 3;
      try {
        const res = await fetch(api("/api/tasks"), {
          method: "POST",
          credentials: "include",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ title, details, priority }),
        });
        if (res.status === 401) return window.location.replace("/ui/login");
        const newTask = await res.json();
        TASKS.push(newTask);
        $("#newTitle").value = $("#newDetails").value = $("#newPriority").value = "";
        render();
      } catch (e) { console.error(e); }
    }

    function render() {
      const q = ($("#search").value || "").toLowerCase();
      const sortVal = $("#sortSelect").value;
      let items = TASKS.slice();
      if (q) items = items.filter(t => JSON.stringify(t).toLowerCase().includes(q));
      if (sortVal === "priorityHighLow") items.sort((a,b) => b.priority - a.priority);
      if (sortVal === "priorityLowHigh") items.sort((a,b) => a.priority - b.priority);

      const todo = items.filter(t => !t.is_complete);
      const completed = items.filter(t => t.is_complete);

      $("#countBadge").textContent = `${items.length} task${items.length === 1 ? "" : "s"}`;
      const bodyTodo = $("#tbody-todo");
      const bodyCompleted = $("#tbody-completed");
      bodyTodo.innerHTML = bodyCompleted.innerHTML = "";

      function makeRow(t) {
        const tr = document.createElement("tr");
        tr.className = t.is_complete ? "completed" : "";
        tr.innerHTML = `
          <td><input type="checkbox" ${t.is_complete ? "checked" : ""}></td>
          <td>${t.title || "(untitled)"}</td>
          <td>${t.details || "—"}</td>
          <td>${t.priority ?? "—"}</td>
          <td><button class="btn danger small">Delete</button></td>
        `;
        const cb = tr.querySelector("input[type=checkbox]");
        cb.onchange = async () => {
          await updateStatus(t.id, cb.checked);
          t.is_complete = cb.checked;
          render();
        };
        const delBtn = tr.querySelector("button");
        delBtn.onclick = (e) => deleteTask(t.id, delBtn);
        return tr;
      }

      for (const t of todo) bodyTodo.appendChild(makeRow(t));
      for (const t of completed) bodyCompleted.appendChild(makeRow(t));
    }

    function logout() {
      fetch(api("/api/logout"), { method: "POST", credentials: "include" })
        .finally(() => window.location.replace("/ui/login"));
    }

    function goToAccount() { window.location.assign("/ui/account"); }

    function showToast(message, nearButton) {
      document.querySelectorAll(".toast-popup").forEach(e => e.remove());
      const popup = document.createElement("div");
      popup.className = "toast-popup";
      popup.textContent = message;
      const rect = nearButton.getBoundingClientRect();
      popup.style.top = `${rect.top + window.scrollY - 40}px`;
      popup.style.left = `${rect.left + rect.width - 120}px`;
      document.body.appendChild(popup);
      setTimeout(() => popup.remove(), 2400);
    }

    (async () => { const ok = await loadUser(); if (ok) await syncTasks(); })();

    async function refreshToken() {
      try {
        const res = await fetch('/api/refresh', {
          method: 'POST',
          credentials: 'include',
        });

        if (res.ok) {
          console.log('✅ Access token refreshed');
        } else {
          console.warn('⚠️ Failed to refresh token:', res.status);
          if (res.status === 401) {
            // refresh token expired — log out gracefully
            window.location.assign('/ui/login');
          }
        }
      } catch (err) {
        console.error('❌ Token refresh error:', err);
      }
    }

    setInterval(refreshToken, 20 * 60 * 1000);
  </script>
</body>
</html>
