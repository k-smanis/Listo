<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Listo - Sign Up</title>
  <style>
    *{box-sizing:border-box}
    body{
      font-family:Arial,sans-serif;
      background:#0b1020;color:#e9ecf8;
      display:flex;align-items:center;justify-content:center;
      height:100vh;margin:0
    }
    .signup-card{
      background:#121a32;padding:30px;border-radius:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      width:100%;max-width:420px;overflow-y:auto;max-height:90vh
    }
    h2{text-align:center;margin:0 0 20px}
    label{display:block;margin-bottom:6px;font-size:14px;color:#9aa4bf}
    input.input{
      width:100%;padding:12px;margin-bottom:16px;
      background:#161e39;border:1px solid #1f2847;border-radius:12px;
      color:#e9ecf8;font-size:14px
    }
    .btn{
      width:100%;padding:12px;
      background:linear-gradient(180deg,#6ea8fe,#4f86f7);
      border:none;border-radius:12px;color:#061024;
      font-weight:700;cursor:pointer;transition:opacity .2s
    }
    .btn:hover{opacity:.95}
    .btn.ghost{
      background:transparent;border:1px solid #1f2847;
      color:#e9ecf8;margin-top:10px
    }
    .btn.ghost:hover{background:#161e39}
    .msg{text-align:center;font-size:14px;margin-top:10px;transition:opacity .5s}
    .msg.hide{opacity:0}
  </style>
</head>
<body>
  <div class="signup-card">
    <h2>Create Account</h2>

    <label>Username</label>
    <input id="username" class="input" type="text" placeholder="Choose a username">

    <label>Email</label>
    <input id="email" class="input" type="email" placeholder="you@example.com">

    <label>First Name</label>
    <input id="first_name" class="input" type="text" placeholder="First name">

    <label>Last Name</label>
    <input id="last_name" class="input" type="text" placeholder="Last name">

    <label>Password</label>
    <input id="password" class="input" type="password" placeholder="Enter password">

    <label>Phone Number</label>
    <input id="phone_number" class="input" type="tel" placeholder="1234567890">

    <button class="btn" onclick="signup()">Sign Up</button>
    <button class="btn ghost" onclick="goToLogin()">Back to Login</button>

    <div class="msg" id="signupMsg"></div>
  </div>

  <script>
    const api = (p) => p;

    function showMessage(text, color="#9aa4bf"){
      const msg=document.getElementById("signupMsg");
      msg.textContent=text;msg.style.color=color;
      msg.classList.remove("hide");
      setTimeout(()=>msg.classList.add("hide"),4000);
    }

    function validateSignup(data){
      const name=/^[A-Za-z\s]+$/;
      const email=/^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$/;
      if(!data.username||!data.email||!data.password){
        showMessage("Please fill in all required fields.","#ff5c5c");return false;
      }
      if(!email.test(data.email)){
        showMessage("Enter a valid email address.","#ff5c5c");return false;
      }
      if(data.password.length<8){
        showMessage("Password must be at least 8 characters.","#ff5c5c");return false;
      }
      if(!name.test(data.first_name)||!name.test(data.last_name)){
        showMessage("Names can only contain Latin letters and spaces.","#ff5c5c");return false;
      }
      if(data.phone_number && !/^\+?\d{7,15}$/.test(data.phone_number)){
        showMessage("Enter a valid phone number (7–15 digits).","#ff5c5c");return false;
      }
      return true;
    }

    async function signup(){
      const data={
        username:document.getElementById("username").value.trim(),
        email:document.getElementById("email").value.trim(),
        first_name:document.getElementById("first_name").value.trim(),
        last_name:document.getElementById("last_name").value.trim(),
        password:document.getElementById("password").value,
        phone_number:document.getElementById("phone_number").value.trim(),
        role:"user"
      };

      if(!validateSignup(data)) return;
      showMessage("Creating account…");

      try{
        const res=await fetch(api("/api/users"),{
          method:"POST",
          headers:{"Content-Type":"application/json","Accept":"application/json"},
          body:JSON.stringify(data)
        });

        if(!res.ok){
          const err=await res.json().catch(()=>({}));
          const msg=err.detail || (Array.isArray(err.detail)?err.detail.map(e=>e.msg).join(" • "):"Signup failed");
          showMessage(msg,"#ff5c5c");
          return;
        }

        showMessage("Account created! Redirecting to login…","#6ea8fe");
        setTimeout(()=>window.location.assign("/ui/login"),1200);
      }catch(e){
        console.error(e);
        showMessage("Network error.","#ff5c5c");
      }
    }

    function goToLogin(){window.location.assign("/ui/login");}

    async function refreshToken() {
      try {
        const res = await fetch('/api/refresh', {
          method: 'POST',
          credentials: 'include',
        });

        if (res.ok) {
          console.log('✅ Access token refreshed');
        } else {
          console.warn('⚠️ Failed to refresh token:', res.status);
          if (res.status === 401) {
            // refresh token expired — log out gracefully
            window.location.assign('/ui/login');
          }
        }
      } catch (err) {
        console.error('❌ Token refresh error:', err);
      }
    }

    setInterval(refreshToken, 20 * 60 * 1000);
  </script>
</body>
</html>
